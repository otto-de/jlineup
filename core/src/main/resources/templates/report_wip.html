<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>JLineup Comparison Report</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <META HTTP-EQUIV="Pragma" CONTENT="no-cache"/>
    <META HTTP-EQUIV="Expires" CONTENT="-1"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

    <style>

        body {
            background-color: white;
            font-family: Arial, Helvetica, sans-serif;
            margin-left: 10px;
            margin-top: 10px;
        }

        .footer {
            margin-top: 25px;
            font-size: 10px;
            color: grey;
        }

        .reporttable tr:nth-child(even) {
            background-color: #eee;
        }

        .reporttable tr:nth-child(odd) {
            background-color: #fff;
        }

        .reporttable th {
            color: white;
            background-color: black;
        }

        .reporttable td {
            padding: 0 0 0 0;
            border: 1px solid;
            border-collapse: collapse;
            vertical-align: top;
            position: relative;
        }

        #report {
            padding: 0 0 15px 20px;
            display: none;
        }

        p {
            padding: 5px;
        }

        label {
            cursor: pointer;
            font-weight: bold;
            font-size: 18px;
        }

        .context input[type=checkbox] {
            display: none;
        }

        .context input[type=checkbox]:checked ~ #report {
            display: block;
        }

        .context input[type=checkbox]:checked ~ label .arrow-down {
            display: block;
        }

        .context input[type=checkbox]:checked ~ label .arrow-right {
            display: none;
        }

        .arrow-right {
            display: block;
            float: left;
            width: 0;
            height: 0;
            margin: 5px 10px 0px 6px;
            border-top: 6px solid transparent;
            border-bottom: 6px solid transparent;
            border-left: 6px solid gray;
        }

        .arrow-down {
            display: none;
            float: left;
            width: 0;
            height: 0;
            margin: 9px 7px 0px 3px;
            border-top: 6px solid gray;
            border-right: 6px solid transparent;
            border-left: 6px solid transparent;
        }

        .success {
            color: green;
        }

        .failure {
            color: red;
        }

        * {
            box-sizing: border-box;
        }

        .zoom-lens {
            position: absolute;
            border: 1px solid #c3c3c3;
            width: 44px;
            height: 44px;
        }

        .zoom {
            border: 1px solid #c3c3c3;
            width: 320px;
            height: 320px;
            image-rendering: pixelated;
        }

        #zoombox {
            position: relative;
        }

        #zoomfix {
            position: fixed;
            /* top: 5px;
            right: 5px; */
            /*width: 965px;
            height: 300px;
            background-color: blue;*/
            z-index: 10;
        }

        .visible {
            display: block;
        }

        .invisible {
            display: none;
        }

        #zoombox div table {
            position: relative;
        }

    </style>

    <script type="application/javascript">

        function initZoom(element) {
            document.getElementById("zoombox").classList.remove("invisible");
            document.getElementById("zoombox").classList.add("visible");
            imageZoomForContext(element.dataset.contextid);
        }

        function stopZoom() {
            document.getElementById("zoombox").classList.add("invisible");
            document.getElementById("zoombox").classList.remove("visible");
        }

        function imageZoomForContext(context) {
            imageZoom(context, 'before_' + context, 'after_' + context, 'diff_' + context, 'zoom_before', 'zoom_after', 'zoom_diff');
        }

        function imageZoom(context, beforeImageId, afterImageId, differenceImageId, zoomBeforeId, zoomAfterId, zoomDifferenceId) {
            const beforeImg = document.getElementById(beforeImageId);
            const afterImg = document.getElementById(afterImageId);
            const differenceImg = document.getElementById(differenceImageId);
            const zoomBefore = document.getElementById(zoomBeforeId);
            const zoomAfter = document.getElementById(zoomAfterId);
            const zoomDifference = document.getElementById(zoomDifferenceId);


            if (beforeImg) {
                let lens = document.getElementById('lens-before_' + context);
                zoom(context, beforeImg, zoomBefore, lens);
            }
            if (afterImg) {
                let lens = document.getElementById('lens-after_' + context);
                zoom(context, afterImg, zoomAfter, lens);
            }
            if (differenceImg) {
                let lens = document.getElementById('lens-difference_' + context);
                zoom(context, differenceImg, zoomDifference, lens);
            }
        }

        function zoom(context, img, zoomImg, lens) {
            lens.addEventListener("mousemove", (e) => moveLens(e, context, lens, img, zoomByLensX, zoomByLensY));

            let zoomByLensX = zoomImg.offsetWidth / lens.offsetWidth;
            let zoomByLensY = zoomImg.offsetHeight / lens.offsetHeight;

            zoomImg.style.backgroundImage = "url('" + img.src + "')";
            zoomImg.style.backgroundSize = (img.width * zoomByLensX) + "px " + (img.height * zoomByLensY) + "px";

            img.addEventListener("mousemove", (e) => moveLens(e, context, lens, img, zoomByLensX, zoomByLensY));
            img.addEventListener("touchmove", (e) => moveLens(e, context, lens, img, zoomByLensX, zoomByLensY));
        }

        function moveLens(e, context, lens, img, zoomByLensX, zoomByLensY) {
            let pos, x, y;
            e.preventDefault();
            pos = getCursorPosition(e, img);
            x = pos.x - (lens.offsetWidth / 2);
            y = pos.y - (lens.offsetHeight / 2);
            if (x > img.width - lens.offsetWidth) {
                x = img.width - lens.offsetWidth;
            }
            if (x < 0) {
                x = 0;
            }
            if (y > img.height - lens.offsetHeight) {
                y = img.height - lens.offsetHeight;
            }
            if (y < 0) {
                y = 0;
            }

            console.log("X: " + e.clientX + " - Y:" + e.clientY);
            let zommfix = document.getElementById("zoomfix");
            zommfix.style.top = (e.clientY - 22) + "px";
            zommfix.style.left = (e.clientX + 25) + "px";

            let lenses = document.getElementsByClassName("lens-" + context);
            for (const lensi of lenses) {
                lensi.style.left = x + "px";
                lensi.style.top = y + "px";
            }

            let zooms = document.getElementsByClassName("zoom");
            for (const zoom of zooms) {
                zoom.style.backgroundPosition = "-" + (x * zoomByLensX) + "px -" + (y * zoomByLensY) + "px";
            }
        }

        function getCursorPosition(e, img) {
            let rect = img.getBoundingClientRect();
            let x = e.pageX - rect.left;
            let y = e.pageY - rect.top;
            x = x - window.pageXOffset;
            y = y - window.pageYOffset;
            return {x: x, y: y};
        }

    </script>
</head>

<body>

<div class="report">
    <h2>JLineup Comparison Report</h2>

    <div id="zoombox" class="invisible">
        <div id="zoomfix">
            <table>
                <tr
                <tr class="reporttable">
                    <th>Before</th>
                    <th>After</th>
                    <th>Difference</th>
                </tr>
                <tr>
                    <td>
                        <div id="zoom_before" class="zoom"></div>
                    </td>
                    <td>
                        <div id="zoom_after" class="zoom"></div>
                    </td>
                    <td>
                        <div id="zoom_diff" class="zoom"></div>
                    </td>
                </tr>
            </table>
        </div>
    </div>

    <div class="context" th:each="resultContext,iterationStatus : ${resultContexts}">
        <input type="checkbox" th:attr="id=${resultContext.contextHash}"/>
        <label th:attr="for=${resultContext.contextHash}"
               th:classappend="${resultContext.isSuccess()} ? success : failure">
            <div class="arrow-right"></div>
            <div class="arrow-down"></div>
            [[${resultContext.url}]] (Width: [[${resultContext.width}]]) <a th:href="${resultContext.url}"
                                                                            target="_blank"
                                                                            th:title="${resultContext.url}">Visit</a>
        </label>
        <table class="reporttable" id="report">
            <tr>
                <th>Info</th>
                <th>Before</th>
                <th>After</th>
                <th>Difference</th>
            </tr>
            <tr th:each="result,iterationStatus : ${resultContext.results}">
                <td>
                    <p>Width: [[${resultContext.width}]]<br/>
                        Scroll pos: [[${result.verticalScrollPosition}]]<br/>
                        Difference: [[${#numbers.formatDecimal(result.difference*100,1,2)}]]%
                    </p>
                </td>
                <td th:switch="${result.screenshotBeforeFileName!=null}">
                    <a th:case="${true}" th:href="${result.screenshotBeforeFileNameForHTML}" target="_blank"
                       th:data-contextid="${resultContext.contextHash + '-' + result.verticalScrollPosition}"
                       onmouseenter="initZoom(this)"
                       onmouseleave="stopZoom()">
                        <div class=" zoom-lens" th:classappend="${'lens-' + resultContext.contextHash + '-' +
                    result.verticalScrollPosition}" th:id="${'lens-before_' + resultContext.contextHash + '-' +
                    result.verticalScrollPosition}">
                        </div>
                        <img th:src="${result.screenshotBeforeFileNameForHTML}" style="max-width: 350px;"
                             th:id="${'before_' + resultContext.contextHash + '-' + result.verticalScrollPosition}"
                        />
                    </a>
                    <p th:case="${false}">No before image</p>
                </td>
                <td th:switch="${result.screenshotAfterFileName!=null}">
                    <a th:case="${true}" th:href="${result.screenshotAfterFileNameForHTML}" target="_blank"
                       th:data-contextid="${resultContext.contextHash + '-' + result.verticalScrollPosition}"
                       onmouseenter="initZoom(this)"
                       onmouseleave="stopZoom()">
                        <div class="zoom-lens"
                             th:classappend="${'lens-' + resultContext.contextHash + '-' + result.verticalScrollPosition}"
                             th:id="${'lens-after_' + resultContext.contextHash + '-' + result.verticalScrollPosition}"></div>
                        <img th:src="${result.screenshotAfterFileNameForHTML}" style="max-width: 350px;"
                             th:id="${'after_' + resultContext.contextHash + '-' + result.verticalScrollPosition}"
                        />
                    </a>
                    <p th:case="${false}">No after image</p>
                </td>
                <td th:switch="${result.differenceImageFileName!=null}">
                    <a th:case="${true}" th:href="${result.differenceImageFileNameForHTML}" target="_blank"
                       th:data-contextid="${resultContext.contextHash + '-' + result.verticalScrollPosition}"
                       onmouseenter="initZoom(this)"
                       onmouseleave="stopZoom()">
                        <div class="zoom-lens"
                             th:classappend="${'lens-' + resultContext.contextHash + '-' + result.verticalScrollPosition}"
                             th:id="${'lens-difference_' + resultContext.contextHash + '-' + result.verticalScrollPosition}"></div>
                        <img th:src="${result.differenceImageFileNameForHTML}" style="max-width: 350px;"
                             th:id="${'diff_' + resultContext.contextHash + '-' + result.verticalScrollPosition}"
                        />
                    </a>
                    <p th:case="${false}">No difference image</p>
                </td>
            </tr>
        </table>
    </div>
</div>

<p class="footer">Generated with Jlineup [[${jlineup_version}]] - [[${jlineup_commit}]] on
    [[${#calendars.format(#calendars.createNow(), 'dd MMM yyyy HH:mm')}]]</p>

</body>
</html>